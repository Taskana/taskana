language: java
jdk:
  - oraclejdk8

services:
  - docker

cache:
  directories:
    - $HOME/.m2
    - web/node_modules
    - web/dist

stages:
  - Build
  - Test
  - BeforeRelease
  - Release
  - Deploy

env:
  global:
    - FORCE_DEPLOY=true
    - NODE_VERSION=8
    - DEPLOY_REPO=Taskana/taskana
  matrix:
    - DB=H2 
    #- DB=DB2_10_5
    #- DB=DB2_11_1
    #- DB=POSTGRES_10_4

stage: Test
script:
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
  - sleep 3 # give xvfb some time to start
  - nvm install $NODE_VERSION
    && ci/change_version.sh -m "lib/ rest/" -swarm lib/taskana-cdi/src/test/java/pro/taskana/TaskanaProducersTest.java
    && ./ci/test.sh $DB

jobs:
  include:
    - stage: Build
      install:
        - nvm install $NODE_VERSION
          && (cd web && npm install && npm rebuild node-sass)
          && ci/change_version.sh -m "lib/ rest/" -swarm lib/taskana-cdi/src/test/java/pro/taskana/TaskanaProducersTest.java
      script:
        - (cd web && npm run build:prod)
          && mvn clean install -q -f lib -DskipTests -Dmaven.javadoc.skip=true
          && mvn clean install -q -f rest -DskipTests -Dmaven.javadoc.skip=true
    - stage: BeforeRelease
      script: 
        - ci/change_version.sh -i -m "lib/ rest/" -swarm lib/taskana-cdi/src/test/java/pro/taskana/TaskanaProducersTest.java
          && ci/copy-rest-spring.sh $TRAVIS_TAG5
          && ci/commitPoms.sh lib/taskana-cdi/src/test/java/pro/taskana/TaskanaProducersTest.java
      if: repo = env(DEPLOY_REPO) AND tag =~ ^v[0-9]+\.[0-9]+\.[0-9]+$
    - stage: Release
      script:
        - ci/release.sh lib/taskana-core $TRAVIS_TAG
          && ci/release.sh lib/taskana-spring $TRAVIS_TAG
          && ci/release.sh lib/taskana-cdi $TRAVIS_TAG
          && ci/release.sh web/ $TRAVIS_TAG
          && ci/release.sh rest/taskana-rest-spring $TRAVIS_TAG
      if: repo = env(DEPLOY_REPO) AND (tag =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ OR branch = master) AND type != pull_request
    - stage: Deploy
      deploy:
        provider: cloudfoundry
        username: mmr@novatec-gmbh.de
        password:
          secure: "QEG1zY45lDieppjMghaDPA90e9lYvbiSvaGS3XEeOCkeRI/lsVpxfGG4oDHIuoig8wmPU0fgdPv1dQKCWnWi3kELZaNOXxbH+QsGYXhvOw5Ba7sQWcVfWjWKf1DtfR8z9J5ndPdR7KY04Z2DxHNle8/S231goSoZqxdQwaQRmFzhzx//U9JbbfXLJH3g+d4R4ZqzPpWSIZPmpZXK1d27ygn+y6NDla6mqyurcIeJ9EH80pfC7zFIilWOjsyvg/lOqoGAB2SvuZfB2t2d+/uZgHvrVd3NIisV5K6XN3bZ7aU/P8osA2Smahc15H2XKmuAPB1/qHQDeuJP97D67eM7SkkMvg5VKjxQBF+E6aijMzHOZEL6OgNezY/Xln1Pz8j0mGjFXXhyy5xVFComcLB3M0aIicyqO9MFoMtCUjLr8LLcK4Y4q7vD5/VTHEU079CAZESm+A9L0HdgKIRsKl5pmjFc7MfsaXg6e+1d5+TIHyD4JgNvkQvSluIBZFI30HXxKrucFk/HaLmyeX04PdFISZ/fqfHi3bQanY6eN7Oj+rLtl+FRyIPoYdL42AcAXzvWsISdImi3QbaBFPHaVk4mUzEzn/mQcoPMrL8VYFEyltcDjbtmo9sGaAkia39PIYwOuivdXLcEHuXMyxXmG105kLsBpIIM3pPIk97ERrgUKO0="
        api: https://api.eu-gb.bluemix.net
        organization: "mmr@novatec-gmbh.de"
        space: dev
        on:
          all_branches: true
      if: (repo = env(DEPLOY_REPO) AND tag =~ ^v[0-9]+\.[0-9]+\.[0-9]+$) OR (env(FORCE_DEPLOY) = true)
